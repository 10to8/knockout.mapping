// Knockout Mapping plugin v2.0beta
// (c) 2011 Steven Sanderson, Roy Jacobs - http://knockoutjs.com/
// License: Ms-Pl (http://www.opensource.org/licenses/ms-pl.html)

ko.exportSymbol=function(l,r){for(var j=l.split("."),m=window,f=0;f<j.length-1;f++)m=m[j[f]];m[j[j.length-1]]=r};ko.exportProperty=function(l,r,j){l[r]=j};
(function(){function l(a,c){for(var b in c)c.hasOwnProperty(b)&&c[b]&&(a[b]&&!(a[b]instanceof Array)?l(a[b],c[b]):a[b]=c[b])}function r(a,c){var b={};l(b,a);l(b,c);return b}function j(a){return a&&typeof a==="object"&&a.constructor==(new Date).constructor?"date":typeof a}function m(a,c){a=a||{};if(a.create instanceof Function||a.update instanceof Function||a.key instanceof Function||a.arrayChanged instanceof Function)a={"":a};if(c)a.ignore=f(c.ignore,a.ignore),a.include=f(c.include,a.include),a.copy=
f(c.copy,a.copy);a.ignore=f(a.ignore,h.ignore);a.include=f(a.include,h.include);a.copy=f(a.copy,h.copy);a.mappedProperties=a.mappedProperties||{};return a}function f(a,c){a instanceof Array||(a=j(a)==="undefined"?[]:[a]);c instanceof Array||(c=j(c)==="undefined"?[]:[c]);return a.concat(c)}function B(a){var c=ko.dependentObservable;ko.dependentObservable=function(a,c,d){d=d||{};d.deferEvaluation=!0;a=new y(a,c,d);a.__ko_proto__=y;return a};a=a();ko.dependentObservable=c;return a}function u(a,c,b,e,
d,f,v){var h=ko.utils.unwrapObservable(c)instanceof Array,v=v||"";if(ko.mapping.isMapped(a))var k=ko.utils.unwrapObservable(a)[o],b=r(k,b);var i=function(){return b[d]&&b[d].create instanceof Function},n=function(){return b[d]&&b[d].update instanceof Function},e=e||new C;if(e.get(c))return a;d=d||"";if(h){var h=[],k=!1,g=function(a){return a};if(b[d]&&b[d].key)g=b[d].key,k=!0;var l=function(a){return a},m=function(a){return a};i()&&(l=function(a){return b[d].create({data:a,parent:f})});n()&&(m=function(a){return b[d].update(ko.uitls.unwrapObservable(a),
{data:value,parent:f})});if(!ko.isObservable(a))a=ko.observableArray([]),a.mappedRemove=function(b){var c=typeof b=="function"?b:function(a){return a===g(b)};return a.remove(function(a){return c(g(a))})},a.mappedRemoveAll=function(b){var c=w(b,g);return a.remove(function(a){return ko.utils.arrayIndexOf(c,g(a))!=-1})},a.mappedDestroy=function(b){var c=typeof b=="function"?b:function(a){return a===g(b)};return a.destroy(function(a){return c(g(a))})},a.mappedDestroyAll=function(b){var c=w(b,g);return a.destroy(function(a){return ko.utils.arrayIndexOf(c,
g(a))!=-1})},a.mappedIndexOf=function(b){var c=w(a(),g),b=g(b);return ko.utils.arrayIndexOf(c,b)},a.mappedCreate=function(b){if(a.mappedIndexOf(b)!==-1)throw Error("There already is an object with the key that you specified.");b=l(b);ko.isWriteableObservable(b)&&b(m(b));a.push(b);return b};i=w(ko.utils.unwrapObservable(a),g).sort();n=w(c,g);k&&n.sort();for(var k=ko.utils.compareArrays(i,n),i={},n=[],p=0,y=k.length;p<y;p++){var t=k[p],s,q=v+"["+p+"]";switch(t.status){case "added":var x=z(ko.utils.unwrapObservable(c),
t.value,g);s=ko.utils.unwrapObservable(u(void 0,x,b,e,d,a,q));q=D(ko.utils.unwrapObservable(c),x,i);n[q]=s;i[q]=!0;break;case "retained":x=z(ko.utils.unwrapObservable(c),t.value,g);s=z(a,t.value,g);u(s,x,b,e,d,a,q);q=D(ko.utils.unwrapObservable(c),x,i);n[q]=s;i[q]=!0;break;case "deleted":s=z(a,t.value,g)}h.push({event:t.status,item:s})}a(n);b[d]&&b[d].arrayChanged&&ko.utils.arrayForEach(h,function(a){b[d].arrayChanged(a.event,a.item)})}else if(A(c)){if(!a)if(i())return B(function(){return b[d].create({data:c,
parent:f})});else a={};if(n())return b[d].update(ko.utils.unwrapObservable(a),{data:c,parent:f});a=ko.utils.unwrapObservable(a);e.save(c,a);E(c,function(d){var f=v.length?v+"."+d:d;if(ko.utils.arrayIndexOf(b.ignore,f)==-1)if(ko.utils.arrayIndexOf(b.copy,f)!=-1)a[d]=c[d];else{var g=e.get(c[d]);if(g)if(ko.isWriteableObservable(a[d]))a[d](g);else a[d]=g;else ko.isWriteableObservable(a[d])?(g=u(a[d](),c[d],b,e,d,a,f),a[d](ko.utils.unwrapObservable(g))):(g=u(a[d],c[d],b,e,d,a,f),a[d]=g);b.mappedProperties[f]=
!0}})}else switch(j(c)){case "function":a=c;break;default:ko.isWriteableObservable(a)?n()?a(b[d].update(ko.utils.unwrapObservable(a),{data:c,parent:f})):a(ko.utils.unwrapObservable(c)):a=i()?B(function(){return b[d].create({data:c,parent:f})}):ko.observable(ko.utils.unwrapObservable(c))}return a}function D(a,c,b){for(var e=0,d=a.length;e<d;e++)if(b[e]!==!0&&a[e]==c)return e;return null}function F(a,c){var b;c&&(b=c(a));j(b)==="undefined"&&(b=a);return ko.utils.unwrapObservable(b)}function z(a,c,b){a=
ko.utils.arrayFilter(ko.utils.unwrapObservable(a),function(a){return F(a,b)===c});if(a.length==0)throw Error("When calling ko.update*, the key '"+c+"' was not found!");if(a.length>1&&A(a[0]))throw Error("When calling ko.update*, the key '"+c+"' was not unique!");return a[0]}function w(a,c){return ko.utils.arrayMap(ko.utils.unwrapObservable(a),function(a){return c?F(a,c):a})}function E(a,c){if(a instanceof Array)for(var b=0;b<a.length;b++)c(b);else for(b in a)c(b)}function A(a){var c=j(a);return c==
"object"&&a!==null&&c!=="undefined"}function C(){var a=[],c=[];this.save=function(b,e){var d=ko.utils.arrayIndexOf(a,b);d>=0?c[d]=e:(a.push(b),c.push(e))};this.get=function(b){b=ko.utils.arrayIndexOf(a,b);return b>=0?c[b]:void 0}}ko.mapping={};var o="__ko_mapping__",y=ko.dependentObservable,p={include:["_destroy"],ignore:[],copy:[]},h=p;ko.mapping.isMapped=function(a){return(a=ko.utils.unwrapObservable(a))&&a[o]};ko.mapping.fromJS=function(a,c,b){if(arguments.length==0)throw Error("When calling ko.fromJS, pass the object you want to convert.");
var e;e=b?r(c,b[o]):c;e=m(e);var d=u(b,a,e);b&&(d=b);d[o]=r(d[o],e);return d};ko.mapping.fromJSON=function(a,c,b){a=ko.utils.parseJson(a);return ko.mapping.fromJS(a,c,b)};ko.mapping.updateFromJS=function(){throw Error("ko.mapping.updateFromJS, use ko.mapping.fromJS instead. Please note that the order of parameters is different!");};ko.mapping.updateFromJSON=function(){throw Error("ko.mapping.updateFromJSON, use ko.mapping.fromJSON instead. Please note that the order of parameters is different!");
};ko.mapping.toJS=function(a,c){h||ko.mapping.resetDefaultOptions();if(arguments.length==0)throw Error("When calling ko.mapping.toJS, pass the object you want to convert.");if(!(h.ignore instanceof Array))throw Error("ko.mapping.defaultOptions().ignore should be an array.");if(!(h.include instanceof Array))throw Error("ko.mapping.defaultOptions().include should be an array.");if(!(h.copy instanceof Array))throw Error("ko.mapping.defaultOptions().copy should be an array.");c=m(c,a[o]);return ko.mapping.visitModel(a,
function(a){return ko.utils.unwrapObservable(a)},c)};ko.mapping.toJSON=function(a,c){var b=ko.mapping.toJS(a,c);return ko.utils.stringifyJson(b)};ko.mapping.defaultOptions=function(){if(arguments.length>0)h=arguments[0];else return h};ko.mapping.resetDefaultOptions=function(){h={include:p.include.slice(0),ignore:p.ignore.slice(0),copy:p.copy.slice(0)}};ko.mapping.visitModel=function(a,c,b){b=b||{};b.visitedObjects=b.visitedObjects||new C;b.parentName||(b=m(b));var e,d=ko.utils.unwrapObservable(a);
if(A(d))c(a,b.parentName),e=d instanceof Array?[]:{};else return c(a,b.parentName);b.visitedObjects.save(a,e);var f=b.parentName;E(d,function(a){if(!(b.ignore&&ko.utils.arrayIndexOf(b.ignore,a)!=-1)){var h=d[a],k=b,i=f||"";d instanceof Array?f&&(i+="["+a+"]"):(f&&(i+="."),i+=a);k.parentName=i;if(!(ko.utils.arrayIndexOf(b.copy,a)===-1&&ko.utils.arrayIndexOf(b.include,a)===-1&&d[o]&&d[o].mappedProperties&&!d[o].mappedProperties[a]&&!(d instanceof Array)))switch(j(ko.utils.unwrapObservable(h))){case "object":case "undefined":k=
b.visitedObjects.get(h);e[a]=j(k)!=="undefined"?k:ko.mapping.visitModel(h,c,b);break;default:e[a]=c(h,b.parentName)}}});return e};ko.exportSymbol("ko.mapping",ko.mapping);ko.exportSymbol("ko.mapping.fromJS",ko.mapping.fromJS);ko.exportSymbol("ko.mapping.fromJSON",ko.mapping.fromJSON);ko.exportSymbol("ko.mapping.isMapped",ko.mapping.isMapped);ko.exportSymbol("ko.mapping.defaultOptions",ko.mapping.defaultOptions);ko.exportSymbol("ko.mapping.toJS",ko.mapping.toJS);ko.exportSymbol("ko.mapping.toJSON",
ko.mapping.toJSON);ko.exportSymbol("ko.mapping.updateFromJS",ko.mapping.updateFromJS);ko.exportSymbol("ko.mapping.updateFromJSON",ko.mapping.updateFromJSON);ko.exportSymbol("ko.mapping.visitModel",ko.mapping.visitModel)})();
